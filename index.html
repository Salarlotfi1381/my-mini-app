<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Crypto Referral Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        }

        .main-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .spinner {
            border-top-color: #00d4ff;
            animation: spin 1s linear infinite;
        }
        
        .crypto-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gold-gradient {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
        }
        
        .green-gradient {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .purple-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .crypto-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
            50% { box-shadow: 0 0 30px rgba(0, 212, 255, 0.6); }
        }
        
        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-white">

    <!-- =========== Human Verification Screen =========== -->
    <div id="verification-screen" class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-6 no-select">
        <div class="crypto-card rounded-3xl p-8 text-center max-w-sm w-full neon-glow">
            <div class="text-6xl mb-6 animate-bounce">üõ°Ô∏è</div>
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">Human Verification</h2>
            <p class="mb-8 text-gray-300">Hold the button below for 4 seconds to continue</p>
            
            <div class="relative mb-6">
                <div class="w-32 h-32 mx-auto relative">
                    <svg class="w-32 h-32 transform -rotate-90">
                        <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/30" />
                        <circle id="progress-circle" cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" stroke-linecap="round" class="text-cyan-400 transition-all duration-100" style="stroke-dasharray: 352; stroke-dashoffset: 352;"></circle>
                    </svg>
                    <button id="hold-button" class="absolute inset-4 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full shadow-lg active:scale-95 transition-transform flex items-center justify-center text-4xl animate-pulse-glow">
                        <span id="hold-icon">üëÜ</span>
                    </button>
                </div>
                <div id="progress-text" class="mt-4 text-lg font-semibold text-cyan-400">0/4 seconds</div>
            </div>
        </div>
    </div>

    <!-- =========== Loading Screen for Data Fetch =========== -->
    <div id="loading-data-screen" class="hidden flex-col items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-6">
        <div class="crypto-card rounded-2xl p-8 text-center">
            <div class="spinner w-12 h-12 border-4 border-gray-600 rounded-full mb-4 mx-auto"></div>
            <p class="font-semibold text-cyan-400">Loading your data...</p>
            <div class="mt-2 text-sm text-gray-400">Connecting to blockchain...</div>
        </div>
    </div>
    
    <!-- =========== Error Screen =========== -->
    <div id="error-screen" class="hidden flex-col items-center justify-center min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-6 text-center">
        <div class="crypto-card rounded-2xl p-8 text-center max-w-sm w-full">
            <div class="text-5xl mb-4">‚ö†Ô∏è</div>
            <h2 class="text-xl font-bold mb-2 text-red-400">Connection Failed</h2>
            <p id="error-message" class="text-gray-300 mb-6">Unable to fetch your data. Please try again.</p>
            <button id="retry-button" class="bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:shadow-lg transition-all">Retry Connection</button>
        </div>
    </div>

    <!-- =========== Main App (Hidden by default) =========== -->
    <div id="main-app" class="main-container min-h-screen hidden">
        <!-- Main Content Area -->
        <div class="pb-24">
            <!-- Home Tab Content -->
            <div id="home-tab" class="p-4 space-y-4">
                <!-- Welcome Card -->
                <div class="crypto-card rounded-2xl p-6 shadow-lg neon-glow">
                    <div class="flex items-center gap-4">
                        <div id="home-avatar" class="w-16 h-16 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full flex-shrink-0 flex items-center justify-center text-xl font-bold border-2 border-cyan-400">
                            <!-- This will be filled by JS -->
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">Welcome <span id="home-username"></span>! üöÄ</h2>
                            <p class="text-gray-300 text-sm">Your Crypto Referral Dashboard</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="crypto-card rounded-xl p-4 shadow-lg gold-gradient">
                        <div class="flex items-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            <span class="font-semibold">Rewards Earned</span>
                        </div>
                        <div class="text-3xl font-bold text-white">$<span id="home-bonus">0</span></div>
                        <div class="text-sm opacity-90">Futures Bonus</div>
                    </div>
                    <div class="crypto-card rounded-xl p-4 shadow-lg green-gradient">
                        <div class="flex items-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span class="font-semibold">Verified Refs</span>
                        </div>
                        <div class="text-3xl font-bold text-white" id="home-referrals">0</div>
                        <div class="text-sm opacity-90"><span id="home-needed-referrals">10</span> more for reward</div>
                    </div>
                </div>

                <!-- Progress Card -->
                <div class="crypto-card rounded-xl p-5 shadow-lg">
                    <h3 class="font-bold text-white mb-3 flex items-center">
                        <span class="w-2 h-2 bg-cyan-400 rounded-full mr-2 animate-pulse"></span>
                        Progress to Next Reward
                    </h3>
                    <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                        <div id="home-progress-bar" class="bg-gradient-to-r from-cyan-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span><span id="home-progress-text">0</span> of 10</span>
                        <span class="text-cyan-400 font-semibold">+$1 Reward</span>
                    </div>
                </div>

                <!-- Recent Referrals -->
                <div class="crypto-card rounded-xl p-5 shadow-lg">
                    <h3 class="font-bold text-white mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-cyan-400">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                        Recent Referrals
                    </h3>
                    <div id="recent-referrals-list" class="space-y-3"></div>
                </div>
            </div>

            <!-- Referral Tab Content (Hidden by default) -->
            <div id="referral-tab" class="p-4 space-y-4 hidden">
                <div class="crypto-card rounded-2xl p-6 shadow-lg neon-glow">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-cyan-400">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        Your Referral Link
                    </h2>
                    <div class="bg-black/20 backdrop-blur-sm rounded-lg p-4 mb-4 border border-cyan-400/30">
                        <div class="text-xs mb-2 opacity-80 text-cyan-400">Invitation Link:</div>
                        <div class="flex items-center gap-2">
                            <div id="referral-link-text" class="flex-1 bg-black/30 rounded-lg p-3 text-xs font-mono break-all text-gray-300"></div>
                            <button id="copy-button" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 p-3 rounded-lg transition-all"></button>
                        </div>
                    </div>
                    <p class="text-center text-xs text-gray-400">Every 10 verified referrals = $1 bonus</p>
                </div>

                <!-- Stats Overview -->
                <div class="crypto-card rounded-xl p-5 shadow-lg">
                    <h3 class="font-bold text-white mb-4">Your Referral Stats</h3>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-cyan-400" id="stats-total">0</div>
                            <div class="text-xs text-gray-400">Total</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-400" id="stats-verified">0</div>
                            <div class="text-xs text-gray-400">Verified</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-yellow-400" id="stats-pending">0</div>
                            <div class="text-xs text-gray-400">Pending</div>
                        </div>
                    </div>
                </div>

                <!-- Full Referrals List -->
                <div class="crypto-card rounded-xl p-5 shadow-lg">
                    <h3 class="font-bold text-white mb-3">Referred Users</h3>
                    <div id="full-referrals-list" class="space-y-3 max-h-80 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Profile Tab Content (Hidden by default) -->
            <div id="profile-tab" class="p-4 space-y-4 hidden">
                <div class="crypto-card rounded-2xl p-6 text-center shadow-lg neon-glow">
                    <div class="w-20 h-20 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl border-2 border-cyan-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent" id="profile-username"></h2>
                    <p class="text-gray-400 mt-1 text-sm">UID: <span id="profile-uid" class="text-cyan-400 font-mono"></span></p>
                </div>

                <!-- Account Stats -->
                <div class="crypto-card rounded-xl p-5 shadow-lg">
                    <h3 class="font-bold text-white mb-3">Account Statistics</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-blue-500/20 rounded-lg border border-blue-500/30">
                            <span class="text-gray-300 text-sm">Total Referrals</span>
                            <span class="font-bold text-blue-400" id="profile-total-referrals"></span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-500/20 rounded-lg border border-green-500/30">
                            <span class="text-gray-300 text-sm">Rewards Earned</span>
                            <span class="font-bold text-green-400">$<span id="profile-total-bonus"></span></span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-500/20 rounded-lg border border-purple-500/30">
                            <span class="text-gray-300 text-sm">Account Status</span>
                            <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-xs font-semibold border border-green-500/30">Active ‚úÖ</span>
                        </div>
                    </div>
                </div>

                <!-- Withdrawal Section -->
                <div class="crypto-card rounded-xl p-5 shadow-lg">
                    <h3 class="font-bold text-white mb-4">Withdraw Rewards</h3>
                    <div id="withdrawal-section"></div>
                </div>

                <!-- Actions -->
                <div class="crypto-card rounded-xl p-5 shadow-lg">
                    <h3 class="font-bold text-white mb-3">Actions</h3>
                    <div class="space-y-2">
                        <button class="w-full text-left p-3 hover:bg-white/10 rounded-lg transition-colors text-sm text-gray-300 flex items-center">
                            <span class="mr-3">‚ùì</span> Help & Support
                        </button>
                        <button class="w-full text-left p-3 hover:bg-red-500/20 rounded-lg transition-colors text-sm text-red-400 flex items-center">
                            <span class="mr-3">üö™</span> Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Menu -->
        <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-black/80 backdrop-blur-sm border-t border-gray-700 px-4 pt-2 pb-4">
            <div id="nav-menu" class="flex justify-around">
                <button data-tab="home" class="nav-button flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors w-20 text-cyan-400 bg-cyan-400/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span class="text-xs">Home</span>
                </button>
                <button data-tab="referral" class="nav-button flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors w-20 text-gray-400 hover:text-cyan-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span class="text-xs">Referral</span>
                </button>
                <button data-tab="profile" class="nav-button flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors w-20 text-gray-400 hover:text-cyan-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span class="text-xs">Profile</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-2 px-5 rounded-full shadow-lg opacity-0 transition-opacity duration-300">Link copied!</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Telegram Web App Setup ---
    const tg = window.Telegram?.WebApp || {
        // Mock object for testing in browser
        initDataUnsafe: { user: { id: 123456, first_name: "TestUser", photo_url: "https://placehold.co/128x128/00d4ff/ffffff?text=T" } },
        ready: () => {}, expand: () => {}, setHeaderColor: () => {},
        showAlert: (message) => alert(message),
        initData: 'mock_init_data'
    };
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#0f0f23');

    // --- DOM Elements ---
    const verificationScreen = document.getElementById('verification-screen');
    const loadingDataScreen = document.getElementById('loading-data-screen');
    const mainApp = document.getElementById('main-app');
    const errorScreen = document.getElementById('error-screen');
    const errorMessage = document.getElementById('error-message');
    const retryButton = document.getElementById('retry-button');
    const holdButton = document.getElementById('hold-button');
    const progressCircle = document.getElementById('progress-circle');
    const progressText = document.getElementById('progress-text');
    const holdIcon = document.getElementById('hold-icon');
    const navMenu = document.getElementById('nav-menu');
    const tabs = {
        home: document.getElementById('home-tab'),
        referral: document.getElementById('referral-tab'),
        profile: document.getElementById('profile-tab'),
    };
    const copyButton = document.getElementById('copy-button');
    const toast = document.getElementById('toast');

    // --- State ---
    let isHolding = false, holdProgress = 0, holdInterval;
    const TOTAL_HOLD_TIME = 4000, INTERVAL_TIME = 50;
    const PROGRESS_INCREMENT = (INTERVAL_TIME / TOTAL_HOLD_TIME) * 100;
    let currentData = {};

    // --- Function Declarations ---
    function showError(message) {
        verificationScreen.classList.add('hidden');
        loadingDataScreen.style.display = 'none';
        mainApp.classList.add('hidden');
        errorMessage.textContent = message;
        errorScreen.style.display = 'flex';
    }
    
    async function fetchUserData() {
        const BACKEND_URL = 'https://bcebbdb800b5.ngrok-free.app/get_user_data';

        if (!tg.initData || tg.initData === 'mock_init_data') {
            showError('User data not found for authentication. Please restart the bot.');
            return null;
        }

        try {
            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });
            if (!response.ok) throw new Error(`Server error: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error("Fetch error:", error);
            showError("Connection failed. Please try again.");
            return null;
        }
    }

    const populateData = (data) => {
        currentData = data;
        const { username, uid, totalReferrals, bonusEarned, referredUsers, bonusThreshold, bonusAmount, photoUrl } = data;
        const referralLink = `https://t.me/cointestpashabot?start=${uid}`;
        
        const verifiedCount = (referredUsers || []).filter(u => u.verified).length;

        // --- Home Tab ---
        document.getElementById('home-username').textContent = username;

        // Avatar handling
        const avatarContainer = document.getElementById('home-avatar');
        if (photoUrl) {
            avatarContainer.innerHTML = '';
            avatarContainer.style.backgroundImage = `url(${photoUrl})`;
            avatarContainer.style.backgroundSize = 'cover';
            avatarContainer.style.backgroundPosition = 'center';
        } else {
            avatarContainer.style.backgroundImage = 'none';
            avatarContainer.textContent = username.charAt(0).toUpperCase() || '?';
        }

        document.getElementById('home-bonus').textContent = bonusEarned.toFixed(2);
        document.getElementById('home-referrals').textContent = verifiedCount;
        
        const currentProgress = verifiedCount % bonusThreshold;
        const needed = bonusThreshold - currentProgress;
        
        document.getElementById('home-needed-referrals').textContent = (needed === bonusThreshold && verifiedCount > 0) ? 0 : needed;
        document.getElementById('home-progress-bar').style.width = `${(currentProgress / bonusThreshold) * 100}%`;
        
        const homeProgressTextContainer = document.querySelector('#home-tab .flex.justify-between.text-xs');
        homeProgressTextContainer.innerHTML = `<span><span id="home-progress-text">${currentProgress}</span> of ${bonusThreshold}</span><span class="text-cyan-400 font-semibold">+$${bonusAmount} Reward</span>`;
        
        const recentList = document.getElementById('recent-referrals-list');
        recentList.innerHTML = '';
        if (referredUsers && referredUsers.length > 0) {
            referredUsers.slice(0, 3).forEach(user => { recentList.innerHTML += createReferralItem(user, 'small'); });
        } else {
            recentList.innerHTML = `<p class="text-center text-sm text-gray-400 py-4">No referrals yet. Start inviting friends!</p>`;
        }
        
        // --- Referral Tab ---
        document.getElementById('referral-link-text').textContent = referralLink;
        copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        document.getElementById('stats-total').textContent = totalReferrals;
        document.getElementById('stats-verified').textContent = verifiedCount;
        document.getElementById('stats-pending').textContent = totalReferrals - verifiedCount;
        document.querySelector('#referral-tab .text-center').textContent = `Every ${bonusThreshold} verified referrals = ${bonusAmount} bonus`;

        const fullList = document.getElementById('full-referrals-list');
        fullList.innerHTML = '';
        if (referredUsers && referredUsers.length > 0) {
            referredUsers.forEach(user => { fullList.innerHTML += createReferralItem(user, 'large'); });
        } else {
             fullList.innerHTML = `<p class="text-center text-sm text-gray-400 py-4">No users referred yet. Share your link to get started!</p>`;
        }

        // --- Profile Tab ---
        document.getElementById('profile-username').textContent = username;
        document.getElementById('profile-uid').textContent = uid;
        document.getElementById('profile-total-referrals').textContent = totalReferrals;
        document.getElementById('profile-total-bonus').textContent = bonusEarned.toFixed(2);

        const withdrawalSection = document.getElementById('withdrawal-section');
        if (bonusEarned > 0) {
            withdrawalSection.innerHTML = `<div class="space-y-4"><div class="bg-green-500/20 p-4 rounded-lg border border-green-500/30"><div class="text-center"><div class="text-3xl font-bold text-green-400">${bonusEarned.toFixed(2)}</div><div class="text-sm text-gray-400 mt-1">Available to Withdraw</div></div></div><button class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all neon-glow">Request Withdrawal</button><p class="text-xs text-gray-400 text-center">Send your account UID to withdraw</p></div>`;
        } else {
            withdrawalSection.innerHTML = `<div class="text-center py-6"><div class="text-5xl mb-4">üí∞</div><p class="text-gray-300 font-semibold">No rewards available yet</p><p class="text-sm text-gray-400 mt-2">${needed} more verified referrals for first reward</p></div>`;
        }
    };
    
    const createReferralItem = (user, type) => {
        const verifiedBadge = user.verified ? 
            `<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full border border-green-500/30">Verified</span>` : 
            `<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded-full border border-yellow-500/30">Pending</span>`;
        const verifiedIcon = user.verified ? 
            `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-green-400"><polyline points="20 6 9 17 4 12"/></svg>` : 
            `<div class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>`;
        const avatarInitial = user.name.charAt(0) || '?';
        const avatarColor = `bg-gradient-to-br from-cyan-500 to-blue-500`;

        if (type === 'small') { 
            return `<div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/10 hover:bg-white/10 transition-colors"><div class="flex items-center"><div class="w-10 h-10 ${avatarColor} rounded-full flex items-center justify-center text-white font-bold text-sm">${avatarInitial}</div><div class="ml-3"><div class="font-semibold text-white text-sm">${user.name}</div><div class="text-xs text-gray-400">${user.joinDate}</div></div></div>${verifiedIcon}</div>`; 
        } 
        else { 
            return `<div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/10 hover:bg-white/10 transition-colors"><div class="flex items-center"><div class="w-11 h-11 ${avatarColor} rounded-full flex items-center justify-center text-white font-bold">${avatarInitial}</div><div class="ml-3"><div class="font-semibold text-white">${user.name}</div><div class="text-sm text-gray-400">Joined: ${user.joinDate}</div></div></div><div class="flex items-center gap-2">${verifiedBadge}</div></div>`; 
        }
    };
    
    const verifyUser = () => {
        holdIcon.textContent = '‚úÖ';
        setTimeout(async () => {
            verificationScreen.classList.add('hidden');
            loadingDataScreen.style.display = 'flex';
            
            const userData = await fetchUserData();

            loadingDataScreen.style.display = 'none';
            if (userData) {
                populateData(userData);
                mainApp.classList.remove('hidden');
            }
        }, 500);
    };

    const startHolding = () => {
        if (isHolding) return;
        isHolding = true;
        holdInterval = setInterval(() => {
            holdProgress += PROGRESS_INCREMENT;
            updateProgressUI();
            if (holdProgress >= 100) {
                clearInterval(holdInterval);
                verifyUser();
            }
        }, INTERVAL_TIME);
    };

    const stopHolding = () => {
        isHolding = false;
        clearInterval(holdInterval);
        if (holdProgress < 100) {
            holdProgress = 0;
            updateProgressUI();
        }
    };
    
    const updateProgressUI = () => {
        const progress = Math.min(holdProgress, 100);
        const radius = 56;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (progress / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
        const seconds = Math.floor((progress / 100) * (TOTAL_HOLD_TIME / 1000));
        progressText.textContent = `${seconds}/4 seconds`;
    };

    // --- Event Listeners ---
    holdButton.addEventListener('mousedown', startHolding);
    holdButton.addEventListener('mouseup', stopHolding);
    holdButton.addEventListener('mouseleave', stopHolding);
    holdButton.addEventListener('touchstart', (e) => { e.preventDefault(); startHolding(); }, { passive: false });
    holdButton.addEventListener('touchend', (e) => { e.preventDefault(); stopHolding(); });

    retryButton.addEventListener('click', () => {
        errorScreen.style.display = 'none';
        loadingDataScreen.style.display = 'flex';
        setTimeout(async () => {
            const userData = await fetchUserData();
            loadingDataScreen.style.display = 'none';
            if (userData) {
                populateData(userData);
                mainApp.classList.remove('hidden');
            }
        }, 500);
    });

    navMenu.addEventListener('click', (e) => {
        const button = e.target.closest('.nav-button');
        if (!button) return;
        const tabToActivate = button.dataset.tab;
        
        navMenu.querySelectorAll('.nav-button').forEach(btn => { 
            btn.classList.remove('text-cyan-400', 'bg-cyan-400/20'); 
            btn.classList.add('text-gray-400', 'hover:text-cyan-400'); 
        });
        Object.values(tabs).forEach(tab => tab.classList.add('hidden'));
        
        button.classList.add('text-cyan-400', 'bg-cyan-400/20');
        button.classList.remove('text-gray-400', 'hover:text-cyan-400');
        tabs[tabToActivate].classList.remove('hidden');
    });

    copyButton.addEventListener('click', () => {
        navigator.clipboard.writeText(`https://t.me/cointestpashabot?start=${currentData.uid}`).then(() => {
            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polyline points="20 6 9 17 4 12"/></svg>`;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
            }, 2000);
        });
    });
});
</script>
</body>
</html>
